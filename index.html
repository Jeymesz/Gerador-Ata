<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ata Sacramental</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=Raleway:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<style>
:root {
  --gold: #8B6914; --gold-light: #C9992A; --cream: #FAF7F2;
  --dark: #1C1810; --muted: #6B6050; --border: #D4C9B0;
  --accent: #4A3728; --blue: #003366;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Raleway', sans-serif; background: #2C2416; background-image: radial-gradient(ellipse at top left, #3D3020 0%, #2C2416 60%); min-height: 100vh; color: var(--dark); }

/* HEADER */
.app-header { text-align: center; padding: 1.8rem 1rem 1.2rem; color: var(--cream); }
.app-header .crest { font-size: 2.2rem; margin-bottom: 0.3rem; filter: drop-shadow(0 2px 8px rgba(200,150,40,0.5)); }
.app-header h1 { font-family: 'EB Garamond', serif; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.04em; color: #E8D89A; }
.ala-edit-wrap { margin-top: 0.35rem; display: flex; justify-content: center; }
.ala-edit-input { background: transparent; border: none; border-bottom: 1px solid rgba(200,170,80,0.45); color: #B8A870; font-family: 'Raleway', sans-serif; font-size: 0.72rem; font-weight: 600; letter-spacing: 0.14em; text-transform: uppercase; text-align: center; padding: 0.15rem 0.5rem; outline: none; width: 220px; transition: border-color 0.2s; }
.ala-edit-input:focus { border-bottom-color: var(--gold-light); color: #E8D89A; }

/* MEETING TYPE */
.meeting-type-bar { display: flex; justify-content: center; gap: 0.6rem; padding: 0 1rem 1rem; flex-wrap: wrap; }
.mtype-btn { background: #3A2E1A; border: 2px solid #5A4830; color: #C9B880; padding: 0.52rem 1.3rem; border-radius: 8px; cursor: pointer; font-family: 'Raleway', sans-serif; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.06em; transition: all 0.2s; }
.mtype-btn:hover { background: #4A3A22; border-color: var(--gold); }
.mtype-btn.active { background: linear-gradient(135deg, #8B6914, #C9992A); border-color: var(--gold-light); color: #FFF8E8; box-shadow: 0 3px 12px rgba(139,105,20,0.35); }

/* TABS */
.tabs { display: flex; justify-content: center; gap: 0.5rem; padding: 0 1rem 1.2rem; }
.tab-btn { background: transparent; border: 1px solid #5A4830; color: #C9B880; padding: 0.48rem 1.5rem; border-radius: 2rem; cursor: pointer; font-family: 'Raleway', sans-serif; font-size: 0.78rem; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; transition: all 0.2s; }
.tab-btn:hover { background: #3D3020; }
.tab-btn.active { background: var(--gold); border-color: var(--gold); color: #FFF8E8; }

.container { max-width: 860px; margin: 0 auto; padding: 0 0.8rem 3rem; }

/* FORM */
.form-panel { background: var(--cream); border-radius: 12px; padding: 1.6rem; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
.form-section { margin-bottom: 1.6rem; }
.form-section-title { font-size: 0.76rem; font-weight: 800; letter-spacing: 0.14em; text-transform: uppercase; color: var(--gold); border-bottom: 2px solid var(--gold-light); padding-bottom: 0.4rem; margin-bottom: 1rem; }
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
.form-grid.cols3 { grid-template-columns: 1fr 1fr 1fr; }
.form-grid.cols1 { grid-template-columns: 1fr; }
.field { display: flex; flex-direction: column; gap: 0.3rem; }
.field label { font-size: 0.68rem; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
.field input, .field textarea, .field select { border: 1px solid var(--border); background: #FFFDF8; border-radius: 6px; padding: 0.48rem 0.7rem; font-family: 'Raleway', sans-serif; font-size: 0.85rem; color: var(--dark); transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
.field input:focus, .field textarea:focus, .field select:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(139,105,20,0.12); }
.field textarea { resize: vertical; min-height: 65px; }

/* HINO PICKER */
.hino-picker-btn { display: flex; align-items: center; gap: 0.6rem; border: 1px solid var(--border); background: #FFFDF8; border-radius: 6px; padding: 0.48rem 0.7rem; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s; min-height: 38px; }
.hino-picker-btn:hover { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(139,105,20,0.12); }
.hino-badge { background: var(--gold); color: #FFF8E8; font-weight: 700; font-size: 0.75rem; padding: 2px 7px; border-radius: 4px; min-width: 30px; text-align: center; white-space: nowrap; }
.hino-text { flex: 1; font-size: 0.85rem; color: var(--dark); }

/* CHAMADO ROW */
.chamado-row { display: grid; grid-template-columns: 88px 1fr 32px; gap: 0.5rem; align-items: end; padding: 0.55rem; background: #F5F0E8; border-radius: 6px; margin-bottom: 0.5rem; }
.chamado-row select { border: 1px solid var(--border); background: #FFFDF8; border-radius: 6px; padding: 0.45rem 0.3rem; font-size: 0.8rem; font-family: 'Raleway', sans-serif; color: var(--dark); outline: none; }

/* TESTEMUNHOS INDICATOR (form) */
.testemunhos-indicator { background: linear-gradient(135deg, #003366 0%, #004488 100%); border-radius: 10px; padding: 1.2rem 1.5rem; text-align: center; margin-bottom: 1.6rem; box-shadow: 0 4px 16px rgba(0,51,102,0.25); }
.test-icon { display: block; font-size: 1.8rem; margin-bottom: 0.35rem; }
.test-label { display: block; font-size: 0.88rem; font-weight: 800; letter-spacing: 0.2em; color: #E8F0FF; margin-bottom: 0.3rem; }
.test-desc { font-size: 0.75rem; color: #A0B8D8; margin: 0; font-style: italic; }

/* BUTTONS */
.add-btn { background: none; border: 1px dashed var(--gold); color: var(--gold); padding: 0.38rem 0.9rem; border-radius: 6px; cursor: pointer; font-size: 0.73rem; font-family: 'Raleway', sans-serif; font-weight: 600; letter-spacing: 0.06em; margin-top: 0.35rem; transition: all 0.2s; }
.add-btn:hover { background: rgba(139,105,20,0.08); }
.remove-btn { background: none; border: none; color: #C0392B; cursor: pointer; font-size: 1.05rem; line-height: 1; padding: 0 0.3rem; transition: opacity 0.2s; }
.remove-btn:hover { opacity: 0.7; }
.generate-btn { display: block; width: 100%; background: linear-gradient(135deg, #8B6914, #C9992A); color: #FFF8E8; border: none; border-radius: 8px; padding: 0.88rem; font-family: 'Raleway', sans-serif; font-size: 0.88rem; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; margin-top: 1.4rem; transition: opacity 0.2s, transform 0.1s; box-shadow: 0 4px 16px rgba(139,105,20,0.3); }
.generate-btn:hover { opacity: 0.9; transform: translateY(-1px); }
.generate-btn:active { transform: translateY(0); }

/* MODAL */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
.modal-overlay.open { display: flex; }
.modal-box { background: var(--cream); border-radius: 12px; width: 100%; max-width: 480px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 24px 60px rgba(0,0,0,0.5); overflow: hidden; }
.modal-header { padding: 1rem 1.2rem 0.8rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.modal-header h3 { font-family: 'EB Garamond', serif; font-size: 1.1rem; color: var(--accent); }
.modal-close { background: none; border: none; font-size: 1.3rem; cursor: pointer; color: var(--muted); line-height: 1; padding: 0 0.2rem; }
.modal-search { padding: 0.7rem 1.2rem; border-bottom: 1px solid var(--border); }
.modal-search input { width: 100%; border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem 0.8rem; font-family: 'Raleway', sans-serif; font-size: 0.88rem; outline: none; background: #FFFDF8; }
.modal-search input:focus { border-color: var(--gold); }
.modal-list { overflow-y: auto; flex: 1; }
.hino-item { display: flex; align-items: center; gap: 0.8rem; padding: 0.6rem 1.2rem; cursor: pointer; border-bottom: 1px solid #EDE8DF; transition: background 0.15s; }
.hino-item:hover { background: #F0EAD8; }
.hino-item .num { font-weight: 700; color: var(--gold); font-size: 0.82rem; min-width: 38px; text-align: right; }
.hino-item .nome { font-size: 0.88rem; color: var(--dark); }
.modal-no-results { text-align: center; padding: 2rem; color: var(--muted); font-size: 0.85rem; }

/* ===== PREVIEW / CARDS ===== */
.action-bar { display: flex; gap: 0.5rem; padding: 0.6rem 0 1rem; justify-content: center; flex-wrap: wrap; }
.action-btn { display: flex; align-items: center; gap: 0.4rem; padding: 0.58rem 1rem; border: none; border-radius: 8px; font-family: 'Raleway', sans-serif; font-size: 0.8rem; font-weight: 700; cursor: pointer; letter-spacing: 0.04em; transition: opacity 0.18s, transform 0.1s; }
.action-btn:active { transform: scale(0.96); }
.btn-whats { background: #25D366; color: #fff; }
.btn-image { background: #4A90D9; color: #fff; }
.btn-print  { background: #666; color: #fff; }

.ata-cards-container { display: flex; flex-direction: column; gap: 0.75rem; padding-bottom: 2rem; }

/* Header card */
.ata-card-header { background: linear-gradient(135deg, #003366 0%, #004D99 100%); border-radius: 14px; padding: 1.3rem 1.1rem 1.1rem; color: white; box-shadow: 0 4px 20px rgba(0,51,102,0.3); }
.ata-card-header .ata-title { font-family: 'EB Garamond', serif; font-size: 1.15rem; font-weight: 600; margin-bottom: 0.15rem; }
.ata-card-header .ata-subtitle { font-size: 0.72rem; opacity: 0.72; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.85rem; }
.ata-meta-row { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.ata-meta-item { background: rgba(255,255,255,0.13); border-radius: 8px; padding: 0.4rem 0.8rem; }
.ata-meta-item span { opacity: 0.65; font-size: 0.66rem; display: block; text-transform: uppercase; letter-spacing: 0.08em; }
.ata-meta-item strong { font-size: 0.95rem; letter-spacing: 0.02em; }

/* Section card */
.ata-card { background: #fff; border-radius: 14px; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,0.08); animation: cardIn 0.35s ease both; }
@keyframes cardIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.ata-card:nth-child(2){animation-delay:.05s} .ata-card:nth-child(3){animation-delay:.10s}
.ata-card:nth-child(4){animation-delay:.14s} .ata-card:nth-child(5){animation-delay:.18s}
.ata-card:nth-child(6){animation-delay:.22s} .ata-card:nth-child(7){animation-delay:.26s}
.ata-card:nth-child(8){animation-delay:.30s}
.ata-card-title { font-size: 0.62rem; font-weight: 800; letter-spacing: 0.14em; text-transform: uppercase; padding: 0.5rem 1rem; border-left: 4px solid var(--gold-light); background: #FAF7F0; color: var(--accent); }
.ata-card-body { padding: 0.85rem 1rem 1rem; display: flex; flex-direction: column; gap: 0.7rem; }

/* CF field */
.ata-cf { display: flex; flex-direction: column; gap: 0.15rem; }
.ata-cf-label { font-size: 0.68rem; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; color: #7A6040; }
.ata-cf-value { font-size: 1.1rem; font-weight: 700; color: #003366; line-height: 1.35; border-bottom: 1.5px solid #EDE8DC; padding-bottom: 0.28rem; }
.ata-cf-value.plain { color: #222; font-weight: 600; font-size: 1rem; }

/* Grids inside card */
.ata-card-grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; }
.ata-card-grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.55rem; }
@media (max-width: 400px) { .ata-card-grid3 { grid-template-columns: 1fr 1fr; } }

/* Hino in card */
.ata-card-hino { display: flex; align-items: center; gap: 0.75rem; background: #F0F6FF; border-radius: 10px; padding: 0.65rem 0.85rem; }
.ata-hino-circle { background: #003366; color: white; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1rem; flex-shrink: 0; }
.ata-hino-info { flex: 1; }
.ata-hino-info-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #7A9AB0; }
.ata-hino-info-name { font-size: 1rem; font-weight: 800; color: #003366; line-height: 1.3; }

/* Chamado item */
.ata-chamado-item { display: flex; align-items: center; gap: 0.65rem; padding: 0.5rem 0; border-bottom: 1px solid #F0ECE4; }
.ata-chamado-item:last-child { border-bottom: none; }
.ata-chamado-badge { width: 27px; height: 27px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.68rem; font-weight: 800; flex-shrink: 0; }
.badge-a { background: #003366; color: white; }
.badge-d { background: #E8EEF5; color: #003366; border: 1.5px solid #003366; }
.ata-chamado-nome { font-size: 1rem; font-weight: 700; color: #1A2A3A; line-height: 1.3; }

/* Anúncio */
.ata-anuncio-item { display: flex; gap: 0.55rem; align-items: flex-start; padding: 0.5rem 0; border-bottom: 1px solid #F0ECE4; font-size: 1rem; font-weight: 600; color: #222; line-height: 1.45; }
.ata-anuncio-item:last-child { border-bottom: none; }
.ata-anuncio-dot { width: 6px; height: 6px; background: var(--gold-light); border-radius: 50%; margin-top: 0.42rem; flex-shrink: 0; }

/* Testemunho card */
.ata-card-testemunho { background: linear-gradient(135deg, #003366 0%, #00509E 100%); border-radius: 14px; padding: 1.3rem 1.1rem; text-align: center; color: white; box-shadow: 0 4px 20px rgba(0,51,102,0.25); animation: cardIn 0.35s ease both; animation-delay: 0.2s; }
.ata-testemunho-icon { font-size: 2rem; margin-bottom: 0.4rem; }
.ata-testemunho-title { font-size: 0.95rem; font-weight: 800; letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 0.35rem; }
.ata-testemunho-desc { font-size: 0.78rem; opacity: 0.72; font-style: italic; }

/* Obs */
.ata-obs-text { font-size: 1rem; font-weight: 600; color: #222; min-height: 28px; line-height: 1.5; white-space: pre-wrap; }

/* Assinaturas */
.ata-sigs { display: flex; gap: 1rem; margin-top: 0.5rem; }
.ata-sig { flex: 1; text-align: center; padding-top: 0.45rem; border-top: 1.5px solid #CCC; font-size: 0.68rem; color: #999; text-transform: uppercase; letter-spacing: 0.06em; }

/* Export loading */
.export-loading { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; color: white; font-family: 'Raleway', sans-serif; gap: 1rem; font-size: 0.9rem; }
.export-spinner { width: 38px; height: 38px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ===== FIREBASE SETUP MODAL ===== */
.fb-setup-overlay {
  position: fixed; inset: 0; background: rgba(20,15,8,0.92);
  z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 1rem;
}
.fb-setup-box {
  background: #FAF7F2; border-radius: 16px; padding: 1.8rem 1.5rem;
  max-width: 480px; width: 100%; box-shadow: 0 24px 60px rgba(0,0,0,0.5);
}
.fb-setup-box h2 { font-family: 'EB Garamond', serif; font-size: 1.3rem; color: #003366; margin-bottom: 0.3rem; }
.fb-setup-box p  { font-size: 0.82rem; color: #666; margin-bottom: 1.2rem; line-height: 1.5; }
.fb-setup-box .step { background: #F0EDE4; border-radius: 8px; padding: 0.8rem 1rem; margin-bottom: 0.8rem; font-size: 0.8rem; color: #444; line-height: 1.6; }
.fb-setup-box .step strong { color: #003366; }
.fb-setup-box .step a { color: #C9992A; text-decoration: none; font-weight: 600; }
.fb-setup-box textarea {
  width: 100%; height: 110px; border: 1px solid #D4C9B0; border-radius: 8px;
  padding: 0.6rem 0.8rem; font-family: 'Courier New', monospace; font-size: 0.75rem;
  resize: none; outline: none; background: #FFFDF8; color: #333; margin-bottom: 0.8rem;
}
.fb-setup-box textarea:focus { border-color: #8B6914; }
.fb-setup-btn {
  width: 100%; background: linear-gradient(135deg,#8B6914,#C9992A); color: #FFF8E8;
  border: none; border-radius: 8px; padding: 0.78rem; font-family: 'Raleway',sans-serif;
  font-size: 0.88rem; font-weight: 700; cursor: pointer; letter-spacing: 0.08em;
}
.fb-setup-btn:hover { opacity: 0.9; }
.fb-skip-btn {
  width: 100%; background: transparent; color: #888; border: 1px solid #D4C9B0;
  border-radius: 8px; padding: 0.6rem; font-family: 'Raleway',sans-serif;
  font-size: 0.8rem; cursor: pointer; margin-top: 0.5rem; letter-spacing: 0.05em;
}

/* ===== SYNC STATUS BAR ===== */
.sync-bar {
  display: none; align-items: center; justify-content: space-between;
  background: #1A2A3A; border-radius: 10px; padding: 0.55rem 0.9rem;
  margin-bottom: 0.8rem; gap: 0.6rem; flex-wrap: wrap;
}
.sync-bar.visible { display: flex; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #aaa; flex-shrink: 0; }
.sync-dot.online  { background: #25D366; box-shadow: 0 0 6px #25D36688; }
.sync-dot.syncing { background: #F0A500; animation: pulse 0.8s infinite alternate; }
@keyframes pulse { to { opacity: 0.3; } }
.sync-label { color: #C8D8E8; font-size: 0.75rem; font-weight: 600; flex: 1; }
.sync-session { color: #7A9AB0; font-size: 0.68rem; font-family: 'Courier New', monospace; letter-spacing: 0.05em; }
.sync-copy-btn {
  background: rgba(255,255,255,0.1); border: none; color: #C8D8E8;
  padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.72rem; cursor: pointer;
  font-family: 'Raleway', sans-serif; font-weight: 600; transition: background 0.2s;
}
.sync-copy-btn:hover { background: rgba(255,255,255,0.2); }
.sync-users { color: #7A9AB0; font-size: 0.72rem; }

/* PRINT A4 */
@media print {
  @page { size: A4 portrait; margin: 12mm 14mm; }
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  body { background: white !important; font-size: 11px; }
  .app-header, .tabs, .form-panel, .action-bar, .meeting-type-bar,
  .modal-overlay, .sync-bar, .fb-setup-overlay { display: none !important; }
  #tab-preview { display: block !important; }
  .ata-cards-container {
    background: white; padding: 0; gap: 4px;
    display: block !important;
  }
  .ata-card {
    box-shadow: none !important;
    border: 1px solid #ccc !important;
    border-radius: 4px !important;
    break-inside: avoid;
    page-break-inside: avoid;
    margin-bottom: 5px;
  }
  .ata-card-header {
    border-radius: 4px !important;
    padding: 8px 10px !important;
    break-inside: avoid;
  }
  .ata-card-header .ata-title { font-size: 13px !important; }
  .ata-card-header .ata-subtitle { font-size: 8px !important; }
  .ata-meta-item { padding: 3px 7px !important; }
  .ata-meta-item strong { font-size: 10px !important; }
  .ata-card-title { font-size: 7px !important; padding: 3px 8px !important; }
  .ata-card-body { padding: 6px 8px !important; gap: 4px !important; }
  .ata-cf-label { font-size: 6px !important; }
  .ata-cf-value { font-size: 10px !important; padding-bottom: 1px !important; }
  .ata-hino-circle { width: 28px !important; height: 28px !important; font-size: 9px !important; }
  .ata-hino-info-name { font-size: 9px !important; }
  .ata-card-hino { padding: 4px 7px !important; }
  .ata-chamado-nome { font-size: 9px !important; }
  .ata-chamado-badge { width: 18px !important; height: 18px !important; font-size: 7px !important; }
  .ata-anuncio-item { font-size: 9px !important; padding: 2px 0 !important; }
  .ata-obs-text { font-size: 9px !important; }
  .ata-sigs { margin-top: 8px !important; }
  .ata-sig { font-size: 7px !important; padding-top: 3px !important; }
  .ata-card-testemunho { border-radius: 4px !important; padding: 10px !important; break-inside: avoid; }
  .ata-card-grid2 { gap: 4px !important; }
  .ata-card-grid3 { gap: 3px !important; }
}

/* ===== MOBILE FIRST ===== */
/* Base: tudo 1 coluna no mobile */
.form-grid { grid-template-columns: 1fr !important; }
.form-grid .field[style*="grid-column:span 2"],
.form-grid .field[style*="grid-column: span 2"] { grid-column: span 1 !important; }

/* Tablet/desktop: 2 colunas */
@media (min-width: 540px) {
  .form-grid { grid-template-columns: 1fr 1fr !important; }
  .form-grid .field[style*="grid-column:span 2"],
  .form-grid .field[style*="grid-column: span 2"] { grid-column: span 2 !important; }
  .form-grid.cols3 { grid-template-columns: 1fr 1fr 1fr !important; }
  .form-grid.cols3 .field[style*="grid-column:span 3"],
  .form-grid.cols3 .field[style*="grid-column: span 3"] { grid-column: span 3 !important; }
  .form-grid.cols1 { grid-template-columns: 1fr !important; }
}

/* Mobile: cols3 vira 1 coluna, campo span3 normal */
@media (max-width: 539px) {
  .form-grid.cols3 { grid-template-columns: 1fr !important; }
  .form-grid.cols3 .field[style*="grid-column:span 3"],
  .form-grid.cols3 .field[style*="grid-column: span 3"] { grid-column: span 1 !important; }
  .chamado-row { grid-template-columns: 80px 1fr 30px; }
  .ata-card-grid2 { grid-template-columns: 1fr; }
  .ata-card-grid3 { grid-template-columns: 1fr 1fr; }
  .meeting-type-bar { flex-direction: column; align-items: center; }
  .mtype-btn { width: 100%; max-width: 300px; text-align: center; }
  .container { padding: 0 0.5rem 3rem; }
  .form-panel { padding: 1.2rem 0.9rem; }
  .tabs { padding: 0 0.5rem 1rem; }
  .action-bar { padding: 0.5rem 0 0.8rem; }
  .action-btn { font-size: 0.75rem; padding: 0.52rem 0.8rem; }
}
</style>
</head>
<body>

<div class="app-header">
  <div class="crest">&#9962;</div>
  <h1>Ata Sacramental</h1>
  <div class="ala-edit-wrap">
    <input type="text" id="ala-nome" value="Ala Vila Gois" class="ala-edit-input" placeholder="Nome da Ala..." />
  </div>
</div>

<div class="meeting-type-bar">
  <button class="mtype-btn active" id="mtype-normal" onclick="setMeetingType('normal')">&#128591; Reuniao Normal</button>
  <button class="mtype-btn" id="mtype-testemunho" onclick="setMeetingType('testemunho')">&#10022; Reuniao de Testemunhos</button>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="showTab('form')">&#9999; Preencher</button>
  <button class="tab-btn" onclick="showTab('preview')">&#128196; Visualizar Ata</button>
</div>

<div class="container">

  <!-- FORM -->
  <div id="tab-form" class="form-panel">

    <!-- Abertura -->
    <div class="form-section">
      <div class="form-section-title">1 · Abertura</div>
      <div class="form-grid">
        <div class="field"><label>Data</label><input type="date" id="data" /></div>
        <div class="field"><label>Frequencia</label><input type="number" id="frequencia" placeholder="ex: 87" /></div>
        <div class="field">
          <label>Presidindo</label>
          <select id="presidindo">
            <option value="">— Selecione —</option>
            <option value="Douglas Crispim">Douglas Crispim</option>
            <option value="Wilmar Modesto Pereira">Wilmar Modesto Pereira</option>
            <option value="Alex Fabiani de Andrade">Alex Fabiani de Andrade</option>
            <option value="Divino Rosa de Jesus">Divino Rosa de Jesus</option>
            <option value="Leonardo de Souza">Leonardo de Souza</option>
            <option value="Leonidio Pereira dos Santos">Leonidio Pereira dos Santos</option>
          </select>
        </div>
        <div class="field">
          <label>Dirigindo</label>
          <select id="dirigindo">
            <option value="">— Selecione —</option>
            <option value="Douglas Crispim">Douglas Crispim</option>
            <option value="Leonardo de Souza">Leonardo de Souza</option>
            <option value="Leonidio Pereira dos Santos">Leonidio Pereira dos Santos</option>
          </select>
        </div>
        <div class="field" style="grid-column:span 2">
          <label>Reconhecimento de Autoridades</label>
          <div id="autoridades-list" style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:0.35rem"></div>
          <button class="add-btn" onclick="addNome('autoridades')">+ Adicionar Autoridade</button>
        </div>
        <div class="field" style="grid-column:span 2">
          <label>Reconhecimento de Visitantes</label>
          <div id="visitantes-list" style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:0.35rem"></div>
          <button class="add-btn" onclick="addNome('visitantes')">+ Adicionar Visitante</button>
        </div>
      </div>
    </div>

    <!-- Anuncios -->
    <div class="form-section">
      <div class="form-section-title">Anuncios</div>
      <div class="field">
        <label>Digite todos os anuncios abaixo</label>
        <textarea id="anuncios-textarea" placeholder="Ex:&#10;• Reuniao de jovens na sexta as 19h&#10;• Entrega de carnets no corredor&#10;• Jovens adultos sabado as 10h" style="min-height:140px;line-height:1.6;font-size:0.9rem;resize:vertical"></textarea>
      </div>
    </div>

    <!-- Musica -->
    <div class="form-section">
      <div class="form-section-title">Musica e Oracao</div>
      <div class="form-grid cols3">
        <div class="field"><label>Regente</label><input type="text" id="regente" /></div>
        <div class="field"><label>Organista</label><input type="text" id="organista" /></div>
        <div class="field"><label>Recepcionista</label><input type="text" id="recepcionista" /></div>
        <div class="field" style="grid-column:span 3">
          <label>1 Hino</label>
          <div class="hino-picker-btn" onclick="openHinoPicker('hino1')">
            <span class="hino-badge" id="hino1-badge">–</span>
            <span class="hino-text" id="hino1-text">Clique para selecionar o hino</span>
            <span>&#127925;</span>
          </div>
          <input type="hidden" id="hino1num"><input type="hidden" id="hino1nome">
        </div>
        <div class="field" style="grid-column:span 3"><label>1 Oracao</label><input type="text" id="oracao1" /></div>
      </div>
    </div>

    <!-- Sacramento -->
    <div class="form-section">
      <div class="form-section-title">3 · Sacramento</div>
      <div class="form-grid">
        <div class="field" style="grid-column:span 2">
          <label>Hino do Sacramento</label>
          <div class="hino-picker-btn" onclick="openHinoPicker('hino_sac')">
            <span class="hino-badge" id="hino_sac-badge">–</span>
            <span class="hino-text" id="hino_sac-text">Clique para selecionar o hino</span>
            <span>&#127925;</span>
          </div>
          <input type="hidden" id="hino_sac_num"><input type="hidden" id="hino_sac_nome">
        </div>
      </div>
    </div>

    <!-- Discursos -->
    <div id="section-discursos">
    <div class="form-section">
      <div class="form-section-title">4 · Discursos</div>
      <div class="form-grid">
        <div class="field"><label>1 Orador</label><input type="text" id="orador1" placeholder="Nome ou TESTEMUNHO" /></div>
        <div class="field"><label>2 Orador</label><input type="text" id="orador2" placeholder="Nome ou TESTEMUNHO" /></div>
        <div class="field" style="grid-column:span 2">
          <label>Hino Especial</label>
          <div class="hino-picker-btn" onclick="openHinoPicker('hino_esp')">
            <span class="hino-badge" id="hino_esp-badge">–</span>
            <span class="hino-text" id="hino_esp-text">Clique para selecionar o hino</span>
            <span>&#127925;</span>
          </div>
          <input type="hidden" id="hino_esp_num"><input type="hidden" id="hino_esp_nome">
        </div>
      </div>
    </div>
    </div><!-- /section-discursos -->

    <!-- Testemunhos block (form) -->
    <div id="form-testemunhos-block" style="display:none;margin-bottom:1.6rem">
      <div class="testemunhos-indicator">
        <span class="test-icon">&#128330;</span>
        <span class="test-label">TESTEMUNHOS</span>
        <p class="test-desc">Momento reservado para os irmaos prestarem seus testemunhos.</p>
      </div>
    </div>

    <!-- Encerramento -->
    <div class="form-section">
      <div class="form-section-title">5 · Encerramento</div>
      <div class="form-grid">
        <div class="field" id="field-ultimo-orador"><label>Ultimo Orador</label><input type="text" id="ultimo_orador" placeholder="Nome ou TESTEMUNHO" /></div>
        <div class="field"><label>Ultima Oracao</label><input type="text" id="ultima_oracao" /></div>
        <div class="field" style="grid-column:span 2">
          <label>Ultimo Hino</label>
          <div class="hino-picker-btn" onclick="openHinoPicker('hino_final')">
            <span class="hino-badge" id="hino_final-badge">–</span>
            <span class="hino-text" id="hino_final-text">Clique para selecionar o hino</span>
            <span>&#127925;</span>
          </div>
          <input type="hidden" id="hino_final_num"><input type="hidden" id="hino_final_nome">
        </div>
      </div>
    </div>

    <!-- Chamados -->
    <div class="form-section">
      <div class="form-section-title">Chamados, Apoios e Desobrigacoes</div>
      <div id="chamados-list"></div>
      <button class="add-btn" onclick="addChamado()">+ Adicionar</button>
    </div>

    <!-- Observacoes -->
    <div class="form-section">
      <div class="form-section-title">6 · Observacoes</div>
      <div class="form-grid cols1">
        <div class="field"><label>Familias Ausentes</label><textarea id="familias_ausentes" placeholder="Listar nomes..."></textarea></div>
        <div class="field"><label>Acoes do Bispado</label><textarea id="acoes_bispado"></textarea></div>
      </div>
    </div>

    <button class="generate-btn" onclick="generateAta()">&#10022; Gerar Ata Sacramental</button>
  </div>

  <!-- PREVIEW -->
  <div id="tab-preview" style="display:none">
    <div class="action-bar" id="action-bar">
      <button class="action-btn btn-whats" onclick="shareWhatsApp()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
        WhatsApp (PDF)
      </button>
      <button class="action-btn btn-image" onclick="saveAsImagePDF()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
        Salvar PDF
      </button>
      <button class="action-btn btn-print" onclick="printAta()">
        <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        Imprimir A4
      </button>
    </div>
    <div id="ata-output" class="ata-cards-container">
      <div style="text-align:center;color:#9A8B70;padding:3rem 1rem;font-size:14px;">
        Preencha o formulario e toque em <strong>Gerar Ata</strong>
      </div>
    </div>
  </div>

</div>

<!-- FIREBASE SETUP MODAL -->
<div class="fb-setup-overlay" id="fb-setup-overlay" style="display:none!important">
  <div class="fb-setup-box">
    <h2>&#128293; Configurar Colaboracao em Tempo Real</h2>
    <p>Para sincronizar a ata com outros dispositivos, conecte ao Firebase (gratuito). Feito uma vez, salvo para sempre.</p>

    <div class="step">
      <strong>1.</strong> Acesse <a href="https://console.firebase.google.com" target="_blank">console.firebase.google.com</a><br>
      <strong>2.</strong> Crie um projeto (ex: <em>ata-sacramental-vilagois</em>)<br>
      <strong>3.</strong> Clique em <em>Realtime Database</em> → Criar banco de dados → Modo de teste<br>
      <strong>4.</strong> Va em Configuracoes do projeto → Adicionar app (Web) → copie o <code>firebaseConfig</code> e cole abaixo
    </div>

    <textarea id="fb-config-input" placeholder='Cole aqui o objeto firebaseConfig:
{
  apiKey: "AIza...",
  authDomain: "...",
  databaseURL: "https://...",
  projectId: "...",
  ...
}'></textarea>
    <div id="fb-config-error" style="color:#C0392B;font-size:0.78rem;margin-bottom:0.5rem;display:none"></div>
    <button class="fb-setup-btn" onclick="connectFirebase()">&#9889; Conectar ao Firebase</button>
    <button class="fb-skip-btn" onclick="skipFirebase()">Usar sem colaboracao (modo offline)</button>
  </div>
</div>

<!-- SYNC BAR (shown when Firebase connected) -->
<div class="sync-bar" id="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span class="sync-label" id="sync-label">Conectando...</span>
  <span class="sync-session" id="sync-session-label"></span>
  <button class="sync-copy-btn" onclick="copyShareLink()" id="sync-share-btn">&#128279; Compartilhar</button>
  <span class="sync-users" id="sync-users-label"></span>
</div>

<!-- MODAL HINOS -->
<div class="modal-overlay" id="hino-modal" onclick="closeModalOutside(event)">
  <div class="modal-box">
    <div class="modal-header">
      <h3>&#127925; Selecionar Hino</h3>
      <button class="modal-close" onclick="closeHinoPicker()">&#x2715;</button>
    </div>
    <div class="modal-search">
      <input type="text" id="hino-search" placeholder="Buscar por numero ou nome..." oninput="filterHinos()" />
    </div>
    <div class="modal-list" id="hino-list"></div>
  </div>
</div>

<script>
let anuncios = [], chamados = [];
let nomes = { autoridades: [], visitantes: [] };
let _uid = 0;
function uid() { return ++_uid; }
let meetingType = 'normal';
let currentPickerTarget = null;

// ── INIT ──────────────────────────────────────────────────────
window.onload = () => {
  const today = new Date();
  document.getElementById('data').value = today.toISOString().split('T')[0];
  addChamado(); addChamado();
  function setHino(target, num, nome) { currentPickerTarget = target; selectHino(num, nome); currentPickerTarget = null; }
  setHino('hino1', '12', 'Que Manha Maravilhosa!');
  setHino('hino_sac', '103', 'Enquanto Unidos em Amor');
  setHino('hino_final', '85', 'Deus Vos Guarde');
  document.getElementById('oracao1').value = 'Leandro da Costa Oliveira';
  document.getElementById('ultimo_orador').value = 'TESTEMUNHO';
  document.getElementById('ultima_oracao').value = 'Fernanda Consuelo Dos Santos';
  document.getElementById('regente').value = 'Marlene Nogueira';
  document.getElementById('organista').value = 'Joseph Isaac Gabriel';
  document.getElementById('presidindo').value = 'Wilmar Modesto Pereira';
  document.getElementById('dirigindo').value = 'Douglas Crispim';
  document.getElementById('orador1').value = 'TESTEMUNHO';
  document.getElementById('orador2').value = 'TESTEMUNHO';
  document.getElementById('ala-nome').value = 'Ala Vila Gois';
  // Sync anuncios textarea
  const ataTa = document.getElementById('anuncios-textarea');
  if (ataTa) ataTa.addEventListener('input', () => { if(!isRemoteUpdate) pushToFirebase(); });
};

// ── MEETING TYPE ─────────────────────────────────────────────
function setMeetingType(type) {
  meetingType = type;
  document.getElementById('mtype-normal').classList.toggle('active', type==='normal');
  document.getElementById('mtype-testemunho').classList.toggle('active', type==='testemunho');
  const d = document.getElementById('section-discursos');
  const u = document.getElementById('field-ultimo-orador');
  const t = document.getElementById('form-testemunhos-block');
  if (type==='testemunho') {
    if(d) d.style.display='none'; if(u) u.style.display='none'; if(t) t.style.display='';
  } else {
    if(d) d.style.display=''; if(u) u.style.display=''; if(t) t.style.display='none';
  }
}

// ── TABS ─────────────────────────────────────────────────────
function showTab(tab) {
  document.getElementById('tab-form').style.display = tab==='form' ? '' : 'none';
  document.getElementById('tab-preview').style.display = tab==='preview' ? '' : 'none';
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active',(i===0&&tab==='form')||(i===1&&tab==='preview')));
}

// ── NAMES (autoridades / visitantes) ─────────────────────────
function addNome(grupo) {
  const id = uid(); nomes[grupo].push(id);
  const el = document.createElement('div');
  el.id = grupo+'-item-'+id;
  el.style.cssText='display:flex;gap:0.5rem;align-items:center';
  el.innerHTML=`<input type="text" id="${grupo}-nome-${id}" placeholder="Nome completo..." style="flex:1;border:1px solid #D4C9B0;background:#FFFDF8;border-radius:6px;padding:0.48rem 0.7rem;font-family:Raleway,sans-serif;font-size:0.85rem;outline:none"><button class="remove-btn" onclick="removeNome('${grupo}',${id})">&#x2715;</button>`;
  document.getElementById(grupo+'-list').appendChild(el);
  const nomeInput = document.getElementById(grupo+'-nome-'+id);
  nomeInput.focus();
  nomeInput.addEventListener('input', () => { if(!isRemoteUpdate) pushToFirebase(); });
}
function removeNome(grupo, id) { nomes[grupo]=nomes[grupo].filter(x=>x!==id); document.getElementById(grupo+'-item-'+id).remove(); }
function getNomes(grupo) { return nomes[grupo].map(id=>{const el=document.getElementById(grupo+'-nome-'+id);return el?el.value.trim():'';}).filter(Boolean); }

// ── ANUNCIOS ─────────────────────────────────────────────────
function addAnuncio() {
  const id = uid(); anuncios.push(id);
  const el = document.createElement('div');
  el.id='anuncio-'+id; el.style.cssText='display:flex;gap:0.5rem;align-items:center;margin-bottom:0.45rem';
  el.innerHTML=`<input type="text" id="anuncio-text-${id}" placeholder="Descreva o anuncio..." style="flex:1;border:1px solid #D4C9B0;background:#FFFDF8;border-radius:6px;padding:0.48rem 0.7rem;font-family:Raleway,sans-serif;font-size:0.85rem;outline:none"><button class="remove-btn" onclick="removeAnuncio(${id})">&#x2715;</button>`;
  document.getElementById('anuncios-list').appendChild(el);
  document.getElementById('anuncio-text-'+id).addEventListener('input', () => { if(!isRemoteUpdate) pushToFirebase(); });
}
function removeAnuncio(id) { anuncios=anuncios.filter(x=>x!==id); document.getElementById('anuncio-'+id).remove(); }

// ── CHAMADOS ─────────────────────────────────────────────────
function addChamado() {
  const id = uid(); chamados.push(id);
  const el = document.createElement('div');
  el.id='chamado-'+id; el.className='chamado-row';
  el.innerHTML=`<select id="chamado-tipo-${id}" style="border:1px solid #D4C9B0;background:#FFFDF8;border-radius:6px;padding:0.45rem 0.3rem;font-size:0.8rem;font-family:Raleway,sans-serif;outline:none"><option value="A">Apoio (A)</option><option value="D">Desobrigacao (D)</option></select><input type="text" id="chamado-nome-${id}" placeholder="Nome — Cargo/Chamado" style="border:1px solid #D4C9B0;background:#FFFDF8;border-radius:6px;padding:0.48rem 0.7rem;font-family:Raleway,sans-serif;font-size:0.85rem;outline:none"><button class="remove-btn" onclick="removeChamado(${id})">&#x2715;</button>`;
  document.getElementById('chamados-list').appendChild(el);
  // Sync when chamado nome or tipo changes
  document.getElementById('chamado-nome-'+id).addEventListener('input', () => { if(!isRemoteUpdate) pushToFirebase(); });
  document.getElementById('chamado-tipo-'+id).addEventListener('change', () => { if(!isRemoteUpdate) pushToFirebase(); });
}
function removeChamado(id) { chamados=chamados.filter(x=>x!==id); document.getElementById('chamado-'+id).remove(); }

// ── HELPERS ──────────────────────────────────────────────────
function v(id) { const el=document.getElementById(id); return el?el.value.trim():''; }
function getAnunciosText() { const el=document.getElementById('anuncios-textarea'); return el?el.value.trim():''; }
function formatDate(d) { if(!d) return {dia:'__',mes:'__',ano:'____'}; const [y,m,dd]=d.split('-'); return {dia:dd,mes:m,ano:y}; }
function cf(label, value, plain=false) {
  return `<div class="ata-cf"><span class="ata-cf-label">${label}</span><span class="ata-cf-value ${plain?'plain':''}">${value||'—'}</span></div>`;
}
function hinoCard(label, num, nome) {
  if(!num && !nome) return '';
  return `<div class="ata-card-hino"><div class="ata-hino-circle">${num||'?'}</div><div class="ata-hino-info"><div class="ata-hino-info-label">${label}</div><div class="ata-hino-info-name">${nome||'—'}</div></div></div>`;
}

// ── HINO PICKER ───────────────────────────────────────────────
const HINOS = [
  {n:'1',nome:'A Alva Rompe'},{n:'2',nome:'Tal Como um Facho'},{n:'3',nome:'Alegres Cantemos'},
  {n:'4',nome:'No Monte a Bandeira'},{n:'5',nome:'Israel, Jesus Te Chama'},{n:'6',nome:'Um Anjo La do Ceu'},
  {n:'7',nome:'O Que Vimos La nos Ceus'},{n:'8',nome:'Oracao pelo Profeta'},{n:'9',nome:'Gracas Damos, O Deus, Por um Profeta'},
  {n:'10',nome:'Vinde ao Profeta Escutar'},{n:'11',nome:'Abencoa Nosso Profeta'},{n:'12',nome:'Que Manha Maravilhosa!'},
  {n:'13',nome:'Rejubilai-vos, O Nacoes'},{n:'14',nome:'Hoje, ao Profeta Louvemos'},{n:'15',nome:'Um Pobre e Aflito Viajor'},
  {n:'16',nome:'O Montanhas Mil'},{n:'17',nome:'Por Teus Dons'},{n:'18',nome:'Vede, O Santos'},{n:'19',nome:'Sereno Finda o Dia'},
  {n:'20',nome:'Vinde, O Santos'},{n:'21',nome:'Ao Salvador Louvemos'},{n:'22',nome:'Em Gloria Resplandesce'},
  {n:'23',nome:'La nos Cumes'},{n:'24',nome:'Vem, O Dia Prometido'},{n:'25',nome:'Bela Siao'},
  {n:'26',nome:'O Mundo Desperta'},{n:'27',nome:'Vinde, O Filhos do Senhor'},{n:'28',nome:'O Vem, Supremo Rei'},
  {n:'29',nome:'O Criaturas do Senhor'},{n:'30',nome:'O Santos, Que na Terra Habitais'},
  {n:'31',nome:'Com Braco Forte'},{n:'32',nome:'Castelo Forte'},{n:'33',nome:'Gloria a Deus Cantai'},
  {n:'34',nome:'Louvai a Deus'},{n:'35',nome:'A Deus, Senhor e Rei'},{n:'36',nome:'Deus E Amor'},
  {n:'37',nome:'O Senhor Meu Pastor E'},{n:'38',nome:'Que Toda Honra e Gloria'},{n:'39',nome:'Coracoes, Pois, Exultai'},
  {n:'40',nome:'Jeova, Se Nosso Guia'},{n:'41',nome:'Firmes Segui'},{n:'42',nome:'Que Firme Alicerce'},
  {n:'43',nome:'Grandioso Es Tu'},{n:'44',nome:'Jesus, Minha Luz'},{n:'45',nome:'O Vos Que Amais ao Senhor'},
  {n:'46',nome:'Nossas Vozes Elevemos'},{n:'47',nome:'Deus nos Rege com Amor'},{n:'48',nome:'O Pai Bendito'},
  {n:'49',nome:'Pela Beleza do Mundo'},{n:'50',nome:'Cantando Louvamos'},{n:'51',nome:'Oracao de Gracas'},
  {n:'52',nome:'Vinde, O Povos, Gracas Dar'},{n:'53',nome:'Se Tenho Fe'},{n:'54',nome:'Doce E o Trabalho'},
  {n:'55',nome:'Santo! Santo! Santo!'},{n:'56',nome:'Os Ceus Proclamam'},{n:'57',nome:'Conta as Bencaos'},
  {n:'58',nome:'Ao Deus de Abraao Louvai'},{n:'59',nome:'Louvai o Eterno Criador'},{n:'60',nome:'Brilha, Meiga Luz'},
  {n:'61',nome:'Carego de Jesus'},{n:'62',nome:'Mais Perto Quero Estar'},{n:'63',nome:'Guia-me a Ti'},
  {n:'64',nome:'O Pai Celeste'},{n:'65',nome:'Jesus Cristo E Meu Senhor'},{n:'66',nome:'Creio em Cristo'},
  {n:'67',nome:'Vive o Redentor'},{n:'68',nome:'Vinde a Mim'},{n:'69',nome:'Vinde a Cristo'},
  {n:'70',nome:'Eu Sei Que Vive Meu Senhor'},{n:'71',nome:'Testemunho'},{n:'72',nome:'Mestre, o Mar Se Revolta'},
  {n:'73',nome:'Onde Encontrar a Paz?'},{n:'74',nome:'Se Humilde'},{n:'75',nome:'Mais Vontade Da-me'},
  {n:'76',nome:'Rocha Eterna'},{n:'77',nome:'A Luz de Deus'},{n:'78',nome:'Embora Cheios de Pesar'},
  {n:'79',nome:'O Doce, Grata Oracao'},{n:'80',nome:'Santo Espirito de Deus'},{n:'81',nome:'Secreta Oracao'},
  {n:'82',nome:'Eis-nos Agora Aqui'},{n:'83',nome:'Com Fervor Fizeste a Prece?'},{n:'84',nome:'So por em Ti, Jesus, Pensar'},
  {n:'85',nome:'Deus Vos Guarde'},{n:'86',nome:'Nos Pedimos-te, Senhor'},{n:'87',nome:'O Bondoso Pai Eterno'},
  {n:'88',nome:'Da-nos, Tu, o Pai Bondoso'},{n:'89',nome:'Ao Partir Cantemos'},{n:'90',nome:'Teu Santo Espirito, Senhor'},
  {n:'91',nome:'Qual Orvalho Que Cintila'},{n:'92',nome:'Vai Fugindo o Dia'},{n:'93',nome:'Suavemente a Noite Cai'},
  {n:'94',nome:'Oracao para a Noite'},{n:'95',nome:'Eis-nos, Hoje, a Teus Pes'},{n:'96',nome:'E Tarde, a Noite Logo Vem'},
  {n:'97',nome:'Comigo Habita'},{n:'98',nome:'O Deus, Senhor Eterno'},{n:'99',nome:'Ao Partilhar de Teu Amor'},
  {n:'100',nome:'Entoai a Deus Louvor'},{n:'101',nome:'Deus, Escuta-nos Orar'},{n:'102',nome:'Nossa Humilde Prece Atende'},
  {n:'103',nome:'Enquanto Unidos em Amor'},{n:'104',nome:'Quao Grato E Cantar Louvor'},{n:'105',nome:'Cantemos Todos a Jesus'},
  {n:'106',nome:'Jesus de Nazare, Mestre e Rei'},{n:'107',nome:'Deus Tal Amor por Nos Mostrou'},
  {n:'108',nome:'Eis-nos a Mesa do Senhor'},{n:'109',nome:'Em uma Cruz Jesus Morreu'},
  {n:'110',nome:'Vede, Morreu o Redentor'},{n:'111',nome:'Lembrando a Morte de Jesus'},
  {n:'112',nome:'Assombro me Causa'},{n:'113',nome:'No Monte do Calvario'},{n:'114',nome:'Da Corte Celestial'},
  {n:'115',nome:'Tao Humilde ao Nascer'},{n:'116',nome:'Sobre o Calvario'},{n:'117',nome:'Com Irmaos Nos Reunidos'},
  {n:'118',nome:'Manha da Ressurreicao'},{n:'119',nome:'Cristo E Ja Ressuscitado'},{n:'120',nome:'Cristo Ja Ressuscitou'},
  {n:'121',nome:'Mundo Feliz, Nasceu Jesus'},{n:'122',nome:'Erguei-vos Cantando'},{n:'123',nome:'La na Judeia, Onde Cristo Nasceu'},
  {n:'124',nome:'Anjos Descem a Cantar'},{n:'125',nome:'Ouvi os Sinos do Natal'},{n:'126',nome:'Noite Feliz'},
  {n:'127',nome:'Jesus num Presepio'},{n:'128',nome:'Na Bela Noite Se Ouviu'},{n:'129',nome:'Pequena Vila de Belem'},
  {n:'130',nome:'No Ceu Desponta Nova Luz'},{n:'131',nome:'No Dia de Natal'},{n:'132',nome:'Eis dos Anjos a Harmonia'},
  {n:'133',nome:'Quando o Anjo Proclamou'},{n:'134',nome:'Sim, Eu Te Seguirei'},{n:'135',nome:'Eu Devo Partilhar'},
  {n:'136',nome:'Neste mundo'},{n:'137',nome:'Oh! Falemos Palavras Ama... veis'},{n:'138',nome:'Nao Deixeis Palavras Duras'},
  {n:'139',nome:'Deus E Consolador Sem Par'},{n:'140',nome:'Ama o Pastor Seu Rebanho'},
  {n:'141',nome:'Trabalhemos Hoje'},{n:'142',nome:'Nossa Lei E Trabalhar'},{n:'143',nome:'Pai, Inspira-me ao Ensinar'},
  {n:'144',nome:'Maos ao Trabalho'},{n:'145',nome:'Sempre Que Alguem Nos Faz o Bem'},{n:'146',nome:'Se a Vida E Penosa'},
  {n:'147',nome:'Faze o Bem'},{n:'148',nome:'Faze o Bem, Escolhendo o Que E Certo'},
  {n:'149',nome:'A Alma E Livre'},{n:'150',nome:'Quem Segue ao Senhor?'},
  {n:'151',nome:'Minha Alma Hoje Tem a luz'},{n:'152',nome:'Prolongue os Bons Momentos'},
  {n:'153',nome:'Deixa a Luz do Sol Entrar'},{n:'154',nome:'Enquanto o Sol Brilha'},
  {n:'155',nome:'Luz Espalhai'},{n:'156',nome:'Agora Nao, mas Logo Mais'},
  {n:'157',nome:'Amor que Cristo Demonstrou'},{n:'158',nome:'Tu Jesus, O Rocha Eterna'},
  {n:'159',nome:'A Gloria Nos Iremos'},{n:'160',nome:'Somos os Soldados'},{n:'161',nome:'As Hostes do Eterno'},
  {n:'162',nome:'Com Valor Marchemos'},{n:'163',nome:'Ide por Todo o Mundo'},{n:'164',nome:'De Um a Outro Polo'},
  {n:'165',nome:'Semeando'},{n:'166',nome:'Chamados a Servir'},{n:'167',nome:'Aonde Mandares Irei'},
  {n:'168',nome:'Povos da Terra, Vinde, Escutai!'},{n:'169',nome:'Eis os Teus Filhos, O Senhor'},
  {n:'170',nome:'Avante, ao Mundo Proclamai'},{n:'171',nome:'A Verdade o Que E?'},
  {n:'172',nome:'A Verdade E Nosso Guia'},{n:'173',nome:'Ao Raiar o Novo Dia'},
  {n:'174',nome:'Se Bem-vindo, Dia Santo'},{n:'175',nome:'Do Po Nos Fala uma Voz'},
  {n:'176',nome:'Estudando as Escrituras'},{n:'177',nome:'O Meu Pai'},{n:'178',nome:'O Quao Majestosa E a Obra de Deus'},
  {n:'179',nome:'O Jeova, Senhor do Ceu'},{n:'180',nome:'Ja Refulge a Gloria Eterna'},
  {n:'181',nome:'O Fim Se Aproxima'},{n:'182',nome:'Juventude da Promessa'},
  {n:'183',nome:'Deve Siao Fugir a Luta?'},{n:'184',nome:'Constantes Qual Firmes Montanhas'},
  {n:'185',nome:'Quao Belos Sao'},{n:'186',nome:'Levantai-vos, Ide ao Templo'},
  {n:'187',nome:'Nos Dedicamos Esta Casa'},{n:'188',nome:'Com Amor no Lar'},{n:'189',nome:'Pode o Lar Ser Como o Ceu'},
  {n:'190',nome:'Os Teus Filhos, Pai Celeste'},{n:'191',nome:'As Familias Poderao Ser Eternas'},
  {n:'192',nome:'O Criancas, Deus Vos Ama'},{n:'193',nome:'Sou um Filho de Deus'},
  {n:'194',nome:'Guarda os Mandamentos'},{n:'195',nome:'Eu Sei que Deus Vive'},
  {n:'196',nome:'Nas Montanhas de Siao'},{n:'197',nome:'Amai-vos Uns aos Outros'},
  {n:'198',nome:'Quando Vejo o Sol Raiar'},{n:'199',nome:'Faz-me Andar So na Luz'},
  {n:'200',nome:'Irmas em Siao'},{n:'201',nome:'O Filhos do Senhor'},{n:'202',nome:'Brilham Raios de Clemencia'},
  {n:'203',nome:'O Elderes de Israel'},{n:'204',nome:'O Vos, Que Sois Chamados'},
  {n:'1001',nome:'O Senhor de toda bencao'},{n:'1002',nome:'Quando o Salvador voltar'},
  {n:'1003',nome:'Minha alma tem paz'},{n:'1004',nome:'Quero andar com Cristo'},
  {n:'1005',nome:'Do passarinho cuida'},{n:'1006',nome:'Pense na cancao'},{n:'1007',nome:'Partido o pao'},
  {n:'1008',nome:'Pao do Ceu, Agua Viva'},{n:'1009',nome:'Getsemani'},{n:'1010',nome:'Sublime graca'},
  {n:'1011',nome:'De maos dadas em uniao'},{n:'1012',nome:'A qualquer hora ou lugar'},
  {n:'1013',nome:'O amor de Deus'},{n:'1014',nome:'O meu Pastor vai me amparar'},
  {n:'1015',nome:'O profundo amor de Cristo'},{n:'1016',nome:'Olhai as maos do Redentor'},
  {n:'1017',nome:'Este e o Cristo'},{n:'1018',nome:'Vem, o Jesus! Vem!'},
  {n:'1019',nome:'Desejo me tornar como Cristo'},{n:'1020',nome:'O Salvador ternamente nos chama'},
  {n:'1021',nome:'Que Cristo me ama eu sei'},{n:'1022',nome:'Fe a cada passo'},
  {n:'1023',nome:'Firme nas promessas'},{n:'1024',nome:'Tenho fe em Jesus, meu Senhor'},
  {n:'1025',nome:'Consagro meu coracao em retidao'},{n:'1026',nome:'Lugares santos'},
  {n:'1027',nome:'Ao virmos, hoje, adorar'},{n:'1028',nome:'Tenho uma luz em mim'},
  {n:'1029',nome:'Muitas bencaos recebo'},{n:'1030',nome:'Tao perto ao orar'},
  {n:'1031',nome:'O, vinde, ouvi a voz divina'},{n:'1032',nome:'Buscai a Cristo'},
  {n:'1033',nome:'Oh, que grande alegria e servir'},{n:'1034',nome:'Pioneiros como eu'},
  {n:'1035',nome:'Neste Dia do Senhor'},{n:'1036',nome:'O Livro de Mormon vou ler'},
  {n:'1037',nome:'Vou viver para a Deus servir'},{n:'1038',nome:'O meu Senhor e meu Pastor'},
  {n:'1039',nome:'Porque'},{n:'1040',nome:'Sua voz a soar'},
  {n:'1041',nome:'Meu coracao e Teu, Jesus'},{n:'1042',nome:'Bondoso Deus, que nos conduz'},
  {n:'1043',nome:'Faz-nos lembrar'},{n:'1044',nome:'Cristo a todos ministrou'},
  {n:'1045',nome:'Vinde a Mim, diz Jesus'},{n:'1046',nome:'Ha no ceu muitas estrelas'},
  {n:'1047',nome:'Ele me conhece bem'},{n:'1048',nome:'A Ti oramos, Pai Celeste'},
  {n:'1049',nome:'Posso orar como Joseph orou'},{n:'1050',nome:'Oh, que estejas junto a mim'},
  {n:'1051',nome:'Senhor, oh, que dia bom!'},{n:'1052',nome:'Com eterna alegria e paz'},
  {n:'1053',nome:'Meus convenios'},{n:'1054',nome:'Quando eu for batizado'},
  {n:'1055',nome:'O Espirito vem testificar'},{n:'1056',nome:'Elias e a mansa voz'},
  {n:'1057',nome:'Meu pastor e Jesus Cristo'},{n:'1058',nome:'Na noite, es minha cancao'},
  {n:'1059',nome:'O mundo Deus criou'},{n:'1060',nome:'Uma arca hoje eu construirei'},
  {n:'1061',nome:'Nosso lar tem amor'},{n:'1062',nome:'Que meu jejum venhas aceitar'},
  {n:'1201',nome:'Eis a Pascoa do Senhor'},{n:'1202',nome:'O menino Jesus nasceu'},
  {n:'1203',nome:'Quem e o menino?'},{n:'1204',nome:'Estrela brilhante e bela'},
  {n:'1205',nome:'Na Pascoa do Senhor'},{n:'1206',nome:'Voce viu?'},{n:'1207',nome:'Noite de paz'},
  {n:'1208',nome:'Ao mundo proclamai'},{n:'1209',nome:'Bebezinho no presepio'},{n:'1210',nome:'Os jardins'}
];

function openHinoPicker(target) {
  currentPickerTarget = target;
  document.getElementById('hino-search').value = '';
  renderHinoList(HINOS);
  document.getElementById('hino-modal').classList.add('open');
  setTimeout(() => document.getElementById('hino-search').focus(), 100);
}
function closeHinoPicker() { document.getElementById('hino-modal').classList.remove('open'); currentPickerTarget = null; }
function closeModalOutside(e) { if(e.target===document.getElementById('hino-modal')) closeHinoPicker(); }
function filterHinos() {
  const q = document.getElementById('hino-search').value.toLowerCase().trim();
  renderHinoList(q ? HINOS.filter(h=>h.n.includes(q)||h.nome.toLowerCase().includes(q)) : HINOS);
}
function renderHinoList(list) {
  const el = document.getElementById('hino-list');
  if(!list.length) { el.innerHTML='<div class="modal-no-results">Nenhum hino encontrado</div>'; return; }
  el.innerHTML='';
  list.forEach(h => {
    const div = document.createElement('div');
    div.className='hino-item';
    div.innerHTML='<span class="num">'+h.n+'</span><span class="nome">'+h.nome+'</span>';
    div.addEventListener('click', () => selectHino(h.n, h.nome));
    el.appendChild(div);
  });
}
function selectHino(num, nome) {
  if(!currentPickerTarget) return;
  const map = {
    'hino1':     {num:'hino1num',      nome:'hino1nome'},
    'hino_sac':  {num:'hino_sac_num',  nome:'hino_sac_nome'},
    'hino_esp':  {num:'hino_esp_num',  nome:'hino_esp_nome'},
    'hino_final':{num:'hino_final_num',nome:'hino_final_nome'}
  };
  const f = map[currentPickerTarget];
  if(f) { document.getElementById(f.num).value=num; document.getElementById(f.nome).value=nome; }
  const badge=document.getElementById(currentPickerTarget+'-badge');
  const text=document.getElementById(currentPickerTarget+'-text');
  if(badge) badge.textContent=num;
  if(text)  { text.textContent=nome; text.classList.remove('placeholder'); }
  closeHinoPicker();
}

// ── SHARE & EXPORT ────────────────────────────────────────────
// ── Helper: gera canvas da ata ────────────────────────────
async function gerarCanvasAta() {
  if (!window.html2canvas) throw new Error('html2canvas nao carregado');
  const container = document.getElementById('ata-output');
  const bar = document.getElementById('action-bar');
  const syncBar = document.getElementById('sync-bar');
  bar.style.display = 'none';
  if (syncBar) syncBar.style.display = 'none';
  await new Promise(r => setTimeout(r, 150));
  const canvas = await html2canvas(container, {
    scale: 2.5,
    backgroundColor: '#F5F0E8',
    useCORS: true,
    logging: false,
    windowWidth: 480,
    width: container.scrollWidth,
    height: container.scrollHeight
  });
  bar.style.display = '';
  if (syncBar && db) syncBar.style.display = '';
  return canvas;
}

// ── Helper: mostra loader ──────────────────────────────────
function showLoader(msg) {
  const loader = document.createElement('div');
  loader.className = 'export-loading';
  loader.id = 'export-loader';
  loader.innerHTML = '<div class="export-spinner"></div><span>' + msg + '</span>';
  document.body.appendChild(loader);
  return loader;
}
function hideLoader() {
  const l = document.getElementById('export-loader');
  if (l) document.body.removeChild(l);
}

// ── Helper: nome do arquivo ────────────────────────────────
function nomeArquivo(ext) {
  const ala = (document.getElementById('ala-nome').value||'ata').replace(/\s+/g,'-').toLowerCase();
  const data = document.getElementById('data').value || '';
  return 'ata-' + (data || ala) + '.' + ext;
}

// ── WhatsApp: gera PDF e compartilha ──────────────────────
async function shareWhatsApp() {
  const loader = showLoader('Gerando PDF para WhatsApp...');
  try {
    const canvas = await gerarCanvasAta();
    const pdf = await canvasParaPDF(canvas);
    const pdfBlob = pdf.output('blob');
    const arquivo = nomeArquivo('pdf');

    // Tenta Web Share API (celular) — suporta arquivos
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([pdfBlob], arquivo, { type: 'application/pdf' })] })) {
      const file = new File([pdfBlob], arquivo, { type: 'application/pdf' });
      hideLoader();
      await navigator.share({ title: 'Ata Sacramental', files: [file] });
    } else {
      // Fallback: baixa o PDF e abre WhatsApp Web com texto
      const url = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = url; link.download = arquivo; link.click();
      URL.revokeObjectURL(url);
      hideLoader();
      const ala = document.getElementById('ala-nome').value || 'Ala';
      const data = document.getElementById('data').value;
      const [y,m,d] = (data||'').split('-');
      const txt = '⛪ *Ata Sacramental – ' + ala + '*\n📅 ' + (data?d+'/'+m+'/'+y:'') + '\n_PDF salvo — envie pelo WhatsApp_';
      setTimeout(() => window.open('https://wa.me/?text=' + encodeURIComponent(txt), '_blank'), 500);
    }
  } catch(e) {
    hideLoader();
    alert('Erro ao gerar PDF: ' + e.message);
  }
}

// ── Salvar PDF (imagem dentro do PDF) ─────────────────────
async function canvasParaPDF(canvas) {
  const { jsPDF } = window.jspdf;
  const imgData = canvas.toDataURL('image/jpeg', 0.95);
  const pxToMm = 25.4 / 96;
  const imgW = canvas.width / 2.5;  // reverter scale
  const imgH = canvas.height / 2.5;
  const mmW = imgW * pxToMm;
  const mmH = imgH * pxToMm;

  // A4: 210 x 297mm
  const A4_W = 210, A4_H = 297;
  const margem = 10;
  const dispW = A4_W - margem * 2;
  const ratio = dispW / mmW;
  const finalW = dispW;
  const finalH = mmH * ratio;

  const pdf = new jsPDF({ orientation: finalH > A4_H ? 'p' : 'p', unit: 'mm', format: 'a4' });
  let posY = margem;
  let restH = finalH;

  while (restH > 0) {
    const pageH = A4_H - margem * 2;
    const sliceH = Math.min(restH, pageH);
    const srcY = (finalH - restH) / ratio / pxToMm * 2.5;
    const slicePx = sliceH / ratio / pxToMm * 2.5;

    // Recortar fatia do canvas para cada pagina
    const sliceCanvas = document.createElement('canvas');
    sliceCanvas.width = canvas.width;
    sliceCanvas.height = Math.ceil(slicePx);
    const ctx = sliceCanvas.getContext('2d');
    ctx.drawImage(canvas, 0, -Math.floor(srcY), canvas.width, canvas.height);
    const sliceImg = sliceCanvas.toDataURL('image/jpeg', 0.95);
    pdf.addImage(sliceImg, 'JPEG', margem, posY, finalW, sliceH);

    restH -= sliceH;
    if (restH > 0) { pdf.addPage(); posY = margem; }
  }
  return pdf;
}

async function saveAsImagePDF() {
  if (!window.html2canvas || !window.jspdf) { alert('Aguarde o carregamento completo e tente novamente.'); return; }
  const loader = showLoader('Gerando PDF...');
  try {
    const canvas = await gerarCanvasAta();
    const pdf = await canvasParaPDF(canvas);
    pdf.save(nomeArquivo('pdf'));
  } catch(e) {
    alert('Erro ao gerar PDF: ' + e.message);
  } finally { hideLoader(); }
}

// ── Imprimir com layout A4 otimizado ─────────────────────
function printAta() {
  window.print();
}

// manter compatibilidade
function saveAsImage() { saveAsImagePDF(); }

// ── GENERATE ATA ──────────────────────────────────────────────
function generateAta() {
  const dt = formatDate(v('data'));
  const freq = v('frequencia') || '—';
  const alaName = document.getElementById('ala-nome').value || 'Ala';
  const autorList = getNomes('autoridades').join(', ');
  const visitList = getNomes('visitantes').join(', ');
  const anunciosRaw = getAnunciosText();
  const anunciosList = anunciosRaw ? anunciosRaw.split('\n').map(l=>l.trim()).filter(Boolean) : [];
  const ultimoOrador = v('ultimo_orador') || '—';

  // Chamados cards
  const chamadosHtml = chamados
    .filter(id => v('chamado-nome-'+id))
    .map(id => {
      const tipo = document.getElementById('chamado-tipo-'+id)?.value || 'A';
      return `<div class="ata-chamado-item">
        <div class="ata-chamado-badge ${tipo==='A'?'badge-a':'badge-d'}">${tipo}</div>
        <div class="ata-chamado-nome">${v('chamado-nome-'+id)}</div>
      </div>`;
    }).join('');

  // Discursos card
  const hinoEspHtml = (v('hino_esp_num')||v('hino_esp_nome'))
    ? hinoCard('Hino Especial', v('hino_esp_num'), v('hino_esp_nome')) : '';
  const discursosBlock = meetingType === 'normal'
    ? `<div class="ata-card">
        <div class="ata-card-title">4 · Discursos</div>
        <div class="ata-card-body">
          ${cf('1 Orador', v('orador1'))}
          ${cf('2 Orador', v('orador2'))}
          ${hinoEspHtml}
        </div>
      </div>` : '';

  // Testemunhos card
  const testemunhosBlock = meetingType === 'testemunho'
    ? `<div class="ata-card-testemunho">
        <div class="ata-testemunho-icon">&#128330;</div>
        <div class="ata-testemunho-title">Testemunhos</div>
        <div class="ata-testemunho-desc">Momento reservado para os irmaos prestarem seus testemunhos.</div>
      </div>` : '';

  document.getElementById('ata-output').innerHTML = `

    <div class="ata-card-header">
      <div class="ata-title">Reuniao Sacramental</div>
      <div class="ata-subtitle">${alaName}</div>
      <div class="ata-meta-row">
        <div class="ata-meta-item"><span>Data</span><strong>${dt.dia}/${dt.mes}/${dt.ano}</strong></div>
        <div class="ata-meta-item"><span>Frequencia</span><strong>${freq}</strong></div>
        <div class="ata-meta-item"><span>Tipo</span><strong>${meetingType==='normal'?'Normal':'Testemunhos'}</strong></div>
      </div>
    </div>

    <div class="ata-card">
      <div class="ata-card-title">1 · Abertura</div>
      <div class="ata-card-body">
        <div class="ata-card-grid2">
          ${cf('Presidindo', v('presidindo'))}
          ${cf('Dirigindo', v('dirigindo'))}
        </div>
        ${autorList ? cf('Reconhecimento de Autoridades', autorList, true) : ''}
        ${visitList ? cf('Reconhecimento de Visitantes', visitList, true) : ''}
        ${anunciosList.length ? `<div>
          <div class="ata-cf-label" style="margin-bottom:0.35rem">Anuncios</div>
          ${anunciosList.map(a=>`<div class="ata-anuncio-item"><div class="ata-anuncio-dot"></div><span>${a}</span></div>`).join('')}
        </div>` : ''}
        <div class="ata-card-grid3">
          ${cf('Regente', v('regente'))}
          ${cf('Organista', v('organista'))}
          ${cf('Recepcionista', v('recepcionista'))}
        </div>
        ${hinoCard('1 Hino', v('hino1num'), v('hino1nome'))}
        ${cf('1 Oracao', v('oracao1'))}
      </div>
    </div>

    <div class="ata-card">
      <div class="ata-card-title">2 · Chamados, Apoios e Desobrigacoes</div>
      <div class="ata-card-body">
        ${chamadosHtml || '<div style="color:#aaa;font-style:italic;font-size:0.85rem">Nenhum chamado registado.</div>'}
      </div>
    </div>

    <div class="ata-card">
      <div class="ata-card-title">3 · Sacramento</div>
      <div class="ata-card-body">
        ${hinoCard('Hino do Sacramento', v('hino_sac_num'), v('hino_sac_nome'))}
      </div>
    </div>

    ${discursosBlock}
    ${testemunhosBlock}

    <div class="ata-card">
      <div class="ata-card-title">5 · Encerramento</div>
      <div class="ata-card-body">
        ${meetingType==='normal' ? cf('Ultimo Orador', ultimoOrador) : ''}
        ${hinoCard('Ultimo Hino', v('hino_final_num'), v('hino_final_nome'))}
        ${cf('Ultima Oracao', v('ultima_oracao'))}
      </div>
    </div>

    <div class="ata-card">
      <div class="ata-card-title">6 · Observacoes</div>
      <div class="ata-card-body">
        <div class="ata-cf">
          <span class="ata-cf-label">Familias Ausentes</span>
          <div class="ata-obs-text">${v('familias_ausentes')||'—'}</div>
        </div>
        <div class="ata-cf">
          <span class="ata-cf-label">Acoes do Bispado</span>
          <div class="ata-obs-text">${v('acoes_bispado')||'—'}</div>
        </div>
        <div class="ata-sigs">
          <div class="ata-sig">Secretario(a) da Ala</div>
          <div class="ata-sig">Bispo</div>
        </div>
      </div>
    </div>

  `;
  showTab('preview');
}

// ══════════════════════════════════════════════════
//  FIREBASE COLLABORATION
// ══════════════════════════════════════════════════
let db = null;
let sessionId = null;
let isSyncing = false;
let syncTimeout = null;
let isRemoteUpdate = false;

// All syncable field IDs
const SYNC_FIELDS = [
  'data','frequencia','presidindo','dirigindo',
  'regente','organista','recepcionista','oracao1',
  'orador1','orador2','ultimo_orador','ultima_oracao',
  'familias_ausentes','acoes_bispado',
  'hino1num','hino1nome','hino_sac_num','hino_sac_nome',
  'hino_esp_num','hino_esp_nome','hino_final_num','hino_final_nome'
];

// ── Setup ──────────────────────────────────────────
function showFirebaseSetup() {
  document.getElementById('fb-setup-overlay').style.display = 'flex';
}
function skipFirebase() {
  document.getElementById('fb-setup-overlay').style.display = 'none';
  localStorage.setItem('fb_skipped','1');
}

function connectFirebase() {
  const raw = document.getElementById('fb-config-input').value.trim();
  const errEl = document.getElementById('fb-config-error');
  errEl.style.display = 'none';

  let config;
  try {
    // Accept both JS object and JSON
    const jsonStr = raw
      .replace(/\/\/.*$/gm,'')
      .replace(/([{,])\s*([a-zA-Z_][a-zA-Z0-9_]*)\s*:/g, '$1"$2":')
      .replace(/'/g,'"');
    const match = jsonStr.match(/\{[\s\S]*\}/);
    if (!match) throw new Error('Formato invalido');
    config = JSON.parse(match[0]);
    if (!config.databaseURL) throw new Error('databaseURL nao encontrado. Certifique-se de ativar o Realtime Database.');
  } catch(e) {
    errEl.textContent = 'Erro: ' + e.message;
    errEl.style.display = 'block';
    return;
  }

  try {
    if (!firebase.apps.length) firebase.initializeApp(config);
    else firebase.app();
    db = firebase.database();
    localStorage.setItem('fb_config', JSON.stringify(config));
    document.getElementById('fb-setup-overlay').style.display = 'none';
    initSession();
  } catch(e) {
    errEl.textContent = 'Erro ao conectar: ' + e.message;
    errEl.style.display = 'block';
  }
}

// initFirebaseFromStorage: replaced by embedded config

// ── Session ID ─────────────────────────────────────
function getSessionId() {
  // Check URL param first
  const params = new URLSearchParams(window.location.search);
  if (params.get('ata')) return params.get('ata');
  // Use today's date as default session
  const d = new Date();
  return 'ata-' + d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function initSession() {
  if (!db || typeof firebase === 'undefined') return;
  sessionId = getSessionId();

  // Update URL without reload
  const url = new URL(window.location.href);
  url.searchParams.set('ata', sessionId);
  window.history.replaceState({}, '', url);

  // Update sync bar
  const bar = document.getElementById('sync-bar');
  bar.classList.add('visible');
  document.getElementById('sync-session-label').textContent = sessionId;
  setSyncStatus('syncing');

  const ref = db.ref('sessions/' + sessionId);

  // Load existing data first
  ref.once('value').then(snap => {
    const data = snap.val();
    if (data && data.fields) {
      isRemoteUpdate = true;
      loadFromSnapshot(data);
      isRemoteUpdate = false;
    }
    setSyncStatus('online');

    // Then listen for real-time changes
    ref.on('value', snap => {
      if (isRemoteUpdate) return;
      const data = snap.val();
      if (!data) return;
      isRemoteUpdate = true;
      loadFromSnapshot(data);
      isRemoteUpdate = false;
      setSyncStatus('online');
    });
  }).catch(() => setSyncStatus('offline'));

  // Track online presence
  const presenceRef = db.ref('sessions/' + sessionId + '/presence/' + generateUID());
  presenceRef.set({ online: true, time: Date.now() });
  presenceRef.onDisconnect().remove();

  // Count online users
  db.ref('sessions/' + sessionId + '/presence').on('value', snap => {
    const count = snap.numChildren();
    const el = document.getElementById('sync-users-label');
    if (count > 0) el.textContent = count + (count===1?' pessoa':' pessoas') + ' online';
    else el.textContent = '';
  });

  // Attach listeners to all fields for syncing
  attachSyncListeners();
}

function generateUID() {
  return Math.random().toString(36).substr(2,9);
}

// ── Sync Helpers ───────────────────────────────────
function setSyncStatus(status) {
  const dot = document.getElementById('sync-dot');
  const label = document.getElementById('sync-label');
  dot.className = 'sync-dot ' + status;
  if (status === 'online')  label.textContent = 'Sincronizado';
  if (status === 'syncing') label.textContent = 'Sincronizando...';
  if (status === 'offline') label.textContent = 'Sem conexao';
}

function collectState() {
  const fields = {};
  SYNC_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) fields[id] = el.value;
  });

  // Autoridades e visitantes
  fields._autoridades = getNomes('autoridades');
  fields._visitantes  = getNomes('visitantes');

  // Anuncios
  const anunciosTa = document.getElementById('anuncios-textarea');
  fields._anuncios_text = anunciosTa ? anunciosTa.value : '';

  // Chamados
  fields._chamados = chamados.map(id => ({
    tipo: document.getElementById('chamado-tipo-' + id)?.value || 'A',
    nome: v('chamado-nome-' + id)
  })).filter(c => c.nome);

  // Hino badges
  ['hino1','hino_sac','hino_esp','hino_final'].forEach(k => {
    const badge = document.getElementById(k + '-badge');
    const text  = document.getElementById(k + '-text');
    if (badge) fields['_badge_' + k] = badge.textContent;
    if (text)  fields['_text_'  + k] = text.textContent;
  });

  fields._meetingType = meetingType;

  return fields;
}

function loadFromSnapshot(data) {
  if (!data.fields) return;
  const f = data.fields;

  SYNC_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el && f[id] !== undefined) el.value = f[id];
  });

  // Restore hino badges/text
  ['hino1','hino_sac','hino_esp','hino_final'].forEach(k => {
    const badge = document.getElementById(k + '-badge');
    const text  = document.getElementById(k + '-text');
    if (badge && f['_badge_' + k]) badge.textContent = f['_badge_' + k];
    if (text  && f['_text_'  + k]) { text.textContent = f['_text_' + k]; text.classList.remove('placeholder'); }
  });

  // Meeting type
  if (f._meetingType && f._meetingType !== meetingType) {
    setMeetingType(f._meetingType);
  }

  // Restore autoridades/visitantes
  if (Array.isArray(f._autoridades)) {
    document.getElementById('autoridades-list').innerHTML = '';
    nomes.autoridades = [];
    f._autoridades.forEach(nome => { addNome('autoridades'); const last = nomes.autoridades[nomes.autoridades.length-1]; if(last) document.getElementById('autoridades-nome-'+last).value = nome; });
  }
  if (Array.isArray(f._visitantes)) {
    document.getElementById('visitantes-list').innerHTML = '';
    nomes.visitantes = [];
    f._visitantes.forEach(nome => { addNome('visitantes'); const last = nomes.visitantes[nomes.visitantes.length-1]; if(last) document.getElementById('visitantes-nome-'+last).value = nome; });
  }

  // Restore anuncios
  if (f._anuncios_text !== undefined) {
    const ta = document.getElementById('anuncios-textarea');
    if (ta) ta.value = f._anuncios_text;
  }

  // Restore chamados
  if (Array.isArray(f._chamados)) {
    document.getElementById('chamados-list').innerHTML = '';
    chamados = [];
    f._chamados.forEach(ch => {
      addChamado();
      const last = chamados[chamados.length-1];
      if (last) {
        document.getElementById('chamado-tipo-'+last).value = ch.tipo;
        document.getElementById('chamado-nome-'+last).value = ch.nome;
      }
    });
  }
}

function pushToFirebase() {
  if (!db || !sessionId || isRemoteUpdate || typeof firebase === 'undefined') return;
  setSyncStatus('syncing');
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(() => {
    const fields = collectState();
    db.ref('sessions/' + sessionId + '/fields').set(fields)
      .then(() => setSyncStatus('online'))
      .catch(() => setSyncStatus('offline'));
  }, 600); // debounce 600ms
}

function attachSyncListeners() {
  SYNC_FIELDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', pushToFirebase);
    if (el && el.tagName === 'SELECT') el.addEventListener('change', pushToFirebase);
  });

  // Watch for meeting type changes (handled in setMeetingType)
  // Watch ONLY for add/remove rows (childList), NOT keystrokes
  // Typing is synced via input listeners attached when each row is created
  const observer = new MutationObserver((mutations) => {
    if (!isRemoteUpdate && mutations.some(m => m.type === 'childList')) pushToFirebase();
  });
  ['chamados-list','autoridades-list','visitantes-list'].forEach(id => {
    const el = document.getElementById(id);
    if (el) observer.observe(el, { childList: true });
  });
}

// Patch setMeetingType to also push to Firebase after toggling
const _setMeetingTypeBase = setMeetingType;
setMeetingType = function(type) {
  _setMeetingTypeBase(type);
  if (!isRemoteUpdate) pushToFirebase();
};

// Copy share link
function copyShareLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    const btn = document.getElementById('sync-share-btn');
    btn.textContent = '✓ Copiado!';
    setTimeout(() => btn.innerHTML = '&#128279; Compartilhar', 2000);
  }).catch(() => {
    // Fallback
    const inp = document.createElement('input');
    inp.value = url;
    document.body.appendChild(inp);
    inp.select();
    document.execCommand('copy');
    document.body.removeChild(inp);
    alert('Link copiado: ' + url);
  });
}

// ── Firebase Config (embutido) ─────────────────────────────
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCyt4GHv2ghUhxNLoEXRHipbWCKXydavdM",
  authDomain: "ata-vila-gois.firebaseapp.com",
  databaseURL: "https://ata-vila-gois-default-rtdb.firebaseio.com",
  projectId: "ata-vila-gois",
  storageBucket: "ata-vila-gois.firebasestorage.app",
  messagingSenderId: "809735939005",
  appId: "1:809735939005:web:1dc1045bfe90c9cbbea8d4"
};

// ── Boot Firebase ──────────────────────────────────
const _origOnload = window.onload;
window.onload = function() {
  if (_origOnload) _origOnload();

  // Move sync bar to top of container
  const bar = document.getElementById('sync-bar');
  const container = document.querySelector('.container');
  if (container && bar) container.prepend(bar);

  // Conectar direto com config embutido
  // (Firebase SDK pode nao estar disponivel em ambientes offline/preview)
  try {
    if (typeof firebase !== 'undefined') {
      if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
      db = firebase.database();
      initSession();
    }
    // Se Firebase nao estiver disponivel, app funciona normalmente em modo offline
  } catch(e) {
    // silencioso — funciona sem Firebase
  }
};
</script>
</body>
</html>
